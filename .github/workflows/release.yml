name: Package and Release ProgramaOT
on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Create ZIP of ProgramaOT folder
        shell: pwsh
        run: |
          if (Test-Path client-to-update.zip) { Remove-Item client-to-update.zip -Force }
          Compress-Archive -Path ProgramaOT\* -DestinationPath client-to-update.zip -Force

      - name: Delete existing asset named client-to-update.zip (if any)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = 'v1.0.0';
            try {
              const release = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
              for (const asset of release.data.assets) {
                if (asset.name === 'client-to-update.zip') {
                  await github.rest.repos.deleteReleaseAsset({ owner, repo, asset_id: asset.id });
                  core.info(`Deleted asset ${asset.name}`);
                }
              }
            } catch (e) {
              core.info(`Release ${tag} not found, will create it.`);
            }

      - name: Create/Update Release v1.0.0 and upload asset
        uses: softprops/action-gh-release@v2
        with:
          files: client-to-update.zip
          name: Client v1.0.0
          tag_name: v1.0.0
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
